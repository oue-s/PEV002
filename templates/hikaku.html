<script>
    const selectableItems = document.getElementById('selectableItems');
    const selectedItems = document.getElementById('selectedItems');
    const selectedItemsInput = document.getElementById('selectedItemsInput');

    let draggingItem = null;
    let touchTimer = null;

    // ドラッグ＆タッチ開始イベント
    document.querySelectorAll('.item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            startDrag(e, item);
        });

        item.addEventListener('touchstart', (e) => {
            // タッチでのドラッグを開始するカスタムロジック
            touchTimer = setTimeout(() => {
                startDrag(e, item);
            }, 300); // 長押しの判定時間を短縮
        });

        item.addEventListener('touchend', () => {
            clearTimeout(touchTimer);
            endDrag();
        });

        item.addEventListener('dragend', () => {
            endDrag();
        });
    });

    function startDrag(event, item) {
        draggingItem = item;
        if (event.type === 'dragstart') {
            event.dataTransfer.setData('text/plain', item.dataset.value);
        }
        item.classList.add('dragging');
    }

    function endDrag() {
        if (draggingItem) {
            draggingItem.classList.remove('dragging');
            draggingItem = null;
        }
    }

    // ドロップ可能エリアイベント
    [selectedItems].forEach(area => {
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('drag-over');
        });

        area.addEventListener('dragleave', () => {
            area.classList.remove('drag-over');
        });

        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('drag-over');
            handleDrop(e);
        });

        area.addEventListener('touchmove', (e) => {
            e.preventDefault();
            area.classList.add('drag-over');
        });

        area.addEventListener('touchend', (e) => {
            e.preventDefault();
            area.classList.remove('drag-over');
            handleDrop(e);
        });
    });

    // ドロップ処理
    function handleDrop(event) {
        if (draggingItem && !selectedItems.contains(draggingItem)) {
            const clonedItem = draggingItem.cloneNode(true);
            clonedItem.querySelector('.remove-btn')?.remove();
            clonedItem.innerHTML += `<button class="remove-btn">削除</button>`;

            // 削除ボタンの動作を設定（タッチ対応追加）
            clonedItem.querySelector('.remove-btn').addEventListener('click', () => {
                selectedItems.removeChild(clonedItem);
                updateHiddenInput();
            });

            clonedItem.querySelector('.remove-btn').addEventListener('touchstart', () => {
                selectedItems.removeChild(clonedItem);
                updateHiddenInput();
            });

            selectedItems.appendChild(clonedItem);
            updateHiddenInput();
        }
    }

    // 隠しフィールド更新
    function updateHiddenInput() {
        const selectedValues = Array.from(selectedItems.children)
            .map(item => item.dataset.value)
            .filter(value => value);
        selectedItemsInput.value = JSON.stringify(selectedValues);
    }
</script>
